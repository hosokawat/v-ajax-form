{"version":3,"file":"v-ajax-form.min.js","sources":["src/components/VAjaxForm.vue","src/main.js"],"sourcesContent":["<template>\n  <form\n    ref=\"formRef\"\n    v-bind=\"$attrs\"\n    :action=\"action\"\n    :method=\"method\"\n    @submit.prevent=\"submit\"\n  >\n    <slot></slot>\n  </form>\n</template>\n<script setup>\nimport { ref, computed } from \"vue\";\n\nconst props = defineProps({\n  action: {\n    type: String,\n    required: true,\n  },\n  method: {\n    type: String,\n    default: \"GET\",\n    validator: (value) =>\n      [\"GET\", \"POST\", \"PUT\", \"DELETE\", \"PATCH\"].includes(value.toUpperCase()),\n  },\n  uriEncode: {\n    type: Boolean,\n    default: false,\n  },\n});\n\nconst emit = defineEmits([\"start\", \"receive\", \"fail\", \"done\"]);\n\ndefineOptions({\n  name: \"VAjaxForm\",\n  inheritAttrs: false,\n});\n\n// テンプレート参照をフォールバックとして用意\nconst formRef = ref(null);\n\n// ファイル入力があるかどうかを判定\nconst hasFileInputs = computed(() => {\n  return formRef.value?.querySelector('input[type=\"file\"]') !== null;\n});\n\nconst request = async (params) => {\n  emit(\"start\", params);\n\n  try {\n    const method = props.method.toUpperCase();\n    let url = props.action;\n    const options = { method: method };\n\n    if (method === \"GET\") {\n      // ファイルアップロードの場合はGETメソッドは使用できない\n      if (params instanceof FormData) {\n        throw new Error(\"File uploads are not supported with GET method\");\n      }\n      const query = new URLSearchParams(params).toString();\n      if (query) {\n        url += (url.indexOf(\"?\") >= 0 ? \"&\" : \"?\") + query;\n      }\n    } else if (method === \"POST\") {\n      if (params instanceof FormData) {\n        // FormDataの場合はContent-Typeヘッダーを設定しない（ブラウザが自動設定）\n        options.body = params;\n      } else {\n        options.headers = {\n          \"Content-Type\": \"application/x-www-form-urlencoded\",\n        };\n        options.body = new URLSearchParams(params);\n      }\n    } else {\n      if (params instanceof FormData) {\n        // PUT, DELETE, PATCHでもFormDataをサポート\n        options.body = params;\n      } else {\n        options.headers = { \"Content-Type\": \"application/json\" };\n        options.body = JSON.stringify(params);\n      }\n    }\n\n    const response = await fetch(url, options);\n\n    if (!response.ok) {\n      throw new Error(\"HTTP error! status: \" + response.status);\n    }\n\n    const text = await response.text();\n    let data;\n    try {\n      data = JSON.parse(text);\n    } catch (e) {\n      data = text;\n    }\n\n    emit(\"receive\", {\n      data: data,\n      status: response.status,\n      statusText: response.statusText,\n    });\n  } catch (error) {\n    emit(\"fail\", error);\n  } finally {\n    emit(\"done\", params);\n  }\n};\n\nconst collectFormData = () => {\n  const form = formRef.value;\n\n  if (!form) {\n    console.warn(\"VAjaxForm: Could not access form element\");\n    return null;\n  }\n\n  // ファイル入力がある場合はFormDataを使用\n  if (hasFileInputs.value) {\n    const formData = new FormData();\n    \n    form.querySelectorAll(\"input,select,textarea\").forEach((el) => {\n      if (\n        typeof el.attributes[\"disabled\"] === \"undefined\" &&\n        typeof el.attributes[\"name\"] !== \"undefined\"\n      ) {\n        const name = el.attributes[\"name\"].value;\n        \n        if (el.type === \"file\") {\n          // ファイル入力の処理\n          Array.from(el.files || []).forEach((file) => {\n            formData.append(name, file);\n          });\n        } else if ((el.type === \"radio\" || el.type === \"checkbox\") && !el.checked) {\n          return;\n        } else {\n          let val = el.value;\n          if (props.uriEncode) {\n            val = encodeURIComponent(val);\n          }\n          formData.append(props.uriEncode ? encodeURIComponent(name) : name, val);\n        }\n      }\n    });\n    \n    return formData;\n  } else {\n    // 通常のフォームデータ処理\n    const params = {};\n    \n    form.querySelectorAll(\"input,select,textarea\").forEach((el) => {\n      if (\n        typeof el.attributes[\"disabled\"] === \"undefined\" &&\n        typeof el.attributes[\"name\"] !== \"undefined\"\n      ) {\n        if ((el.type === \"radio\" || el.type === \"checkbox\") && !el.checked)\n          return;\n        let val = el.value;\n        let name = el.attributes[\"name\"].value;\n        if (props.uriEncode) {\n          val = encodeURIComponent(val);\n          name = encodeURIComponent(name);\n        }\n        if (typeof params[name] === \"undefined\") {\n          params[name] = val;\n        } else if (params[name] instanceof Array) {\n          params[name].push(val);\n        } else {\n          params[name] = [params[name], val];\n        }\n      }\n    });\n    \n    return params;\n  }\n};\n\nconst submit = async () => {\n  const formData = collectFormData();\n  if (formData !== null) {\n    await request(formData);\n  }\n};\n</script>\n","import VAjaxForm from \"./components/VAjaxForm.vue\";\n\nconst VAjaxFormPlugin = {\n  install(app) {\n    app.component(\"v-ajax-form\", VAjaxForm);\n  },\n};\n\n// Auto-install when Vue is found (browser)\nif (typeof window !== \"undefined\" && window.Vue && window.Vue.createApp) {\n  // Vue 3のグローバル変数として利用可能にする\n  window.VAjaxForm = VAjaxFormPlugin;\n}\n\nexport default VAjaxFormPlugin;\n"],"names":["props","__props","emit","__emit","formRef","ref","hasFileInputs","computed","value","querySelector","submit","async","formData","form","console","warn","FormData","querySelectorAll","forEach","el","attributes","name","type","Array","from","files","file","append","checked","val","uriEncode","encodeURIComponent","params","push","collectFormData","method","toUpperCase","url","action","options","Error","query","URLSearchParams","toString","indexOf","body","headers","JSON","stringify","response","fetch","ok","status","text","data","parse","e","statusText","error","request","_openBlock","_createElementBlock","_mergeProps","$attrs","onSubmit","_renderSlot","_ctx","$slots","VAjaxFormPlugin","install","app","component","VAjaxForm","window","Vue","createApp"],"mappings":"iYAcA,MAAMA,EAAQC,EAiBRC,EAAOC,EAQPC,EAAUC,EAAGA,IAAC,MAGdC,EAAgBC,EAAQA,UAAC,IACiC,OAAvDH,EAAQI,OAAOC,cAAc,wBAsIhCC,EAASC,UACb,MAAMC,EArEgB,MACtB,MAAMC,EAAOT,EAAQI,MAErB,IAAKK,EAEH,OADAC,QAAQC,KAAK,4CACN,KAIT,GAAIT,EAAcE,MAAO,CACvB,MAAMI,EAAW,IAAII,SA0BrB,OAxBAH,EAAKI,iBAAiB,yBAAyBC,SAASC,IACtD,QACuC,IAA9BA,EAAGC,WAAqB,eACE,IAA1BD,EAAGC,WAAiB,KAC3B,CACA,MAAMC,EAAOF,EAAGC,WAAiB,KAAEZ,MAEnC,GAAgB,SAAZW,EAAGG,KAELC,MAAMC,KAAKL,EAAGM,OAAS,IAAIP,SAASQ,IAClCd,EAASe,OAAON,EAAMK,UAEnB,MAAiB,UAAZP,EAAGG,MAAgC,aAAZH,EAAGG,MAAyBH,EAAGS,SAChE,OACK,CACL,IAAIC,EAAMV,EAAGX,MACTR,EAAM8B,YACRD,EAAME,mBAAmBF,IAE3BjB,EAASe,OAAO3B,EAAM8B,UAAYC,mBAAmBV,GAAQA,EAAMQ,EAC7E,EACA,KAGWjB,CACX,CAAS,CAEL,MAAMoB,EAAS,CAAE,EAyBjB,OAvBAnB,EAAKI,iBAAiB,yBAAyBC,SAASC,IACtD,QACuC,IAA9BA,EAAGC,WAAqB,eACE,IAA1BD,EAAGC,WAAiB,KAC3B,CACA,IAAiB,UAAZD,EAAGG,MAAgC,aAAZH,EAAGG,QAAyBH,EAAGS,QACzD,OACF,IAAIC,EAAMV,EAAGX,MACTa,EAAOF,EAAGC,WAAiB,KAAEZ,MAC7BR,EAAM8B,YACRD,EAAME,mBAAmBF,GACzBR,EAAOU,mBAAmBV,SAEA,IAAjBW,EAAOX,GAChBW,EAAOX,GAAQQ,EACNG,EAAOX,aAAiBE,MACjCS,EAAOX,GAAMY,KAAKJ,GAElBG,EAAOX,GAAQ,CAACW,EAAOX,GAAOQ,EAExC,KAGWG,CACX,GAImBE,GACA,OAAbtB,QArIUD,OAAOqB,IACrB9B,EAAK,QAAS8B,GAEd,IACE,MAAMG,EAASnC,EAAMmC,OAAOC,cAC5B,IAAIC,EAAMrC,EAAMsC,OAChB,MAAMC,EAAU,CAAEJ,OAAQA,GAE1B,GAAe,QAAXA,EAAkB,CAEpB,GAAIH,aAAkBhB,SACpB,MAAM,IAAIwB,MAAM,kDAElB,MAAMC,EAAQ,IAAIC,gBAAgBV,GAAQW,WACtCF,IACFJ,IAAQA,EAAIO,QAAQ,MAAQ,EAAI,IAAM,KAAOH,EAErD,KAA0B,SAAXN,EACLH,aAAkBhB,SAEpBuB,EAAQM,KAAOb,GAEfO,EAAQO,QAAU,CAChB,eAAgB,qCAElBP,EAAQM,KAAO,IAAIH,gBAAgBV,IAGjCA,aAAkBhB,SAEpBuB,EAAQM,KAAOb,GAEfO,EAAQO,QAAU,CAAE,eAAgB,oBACpCP,EAAQM,KAAOE,KAAKC,UAAUhB,IAIlC,MAAMiB,QAAiBC,MAAMb,EAAKE,GAElC,IAAKU,EAASE,GACZ,MAAM,IAAIX,MAAM,uBAAyBS,EAASG,QAGpD,MAAMC,QAAaJ,EAASI,OAC5B,IAAIC,EACJ,IACEA,EAAOP,KAAKQ,MAAMF,EACnB,CAAC,MAAOG,GACPF,EAAOD,CACb,CAEInD,EAAK,UAAW,CACdoD,KAAMA,EACNF,OAAQH,EAASG,OACjBK,WAAYR,EAASQ,YAExB,CAAC,MAAOC,GACPxD,EAAK,OAAQwD,EACjB,CAAY,QACRxD,EAAK,OAAQ8B,EACjB,GA0EU2B,CAAQ/C,kBAnLhBgD,cAAAC,qBAQO,OARPC,EAAAA,WAQO,SAPD,UAAJzD,IAAID,GACI2D,EAAMA,OAAA,CACbzB,OAAQrC,EAAMqC,OACdH,OAAQlC,EAAMkC,OACd6B,yBAAgBtD,EAAM,CAAA,eAEvBuD,aAAaC,EAAAC,OAAA,sBCNXC,EAAkB,CACtB,OAAAC,CAAQC,GACNA,EAAIC,UAAU,cAAeC,EAC9B,SAImB,oBAAXC,QAA0BA,OAAOC,KAAOD,OAAOC,IAAIC,YAE5DF,OAAOD,UAAYJ"}